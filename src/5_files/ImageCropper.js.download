(function(y){y.ImageCropper=function(z,y,E){function A(b){F();t.show();t.addClass("notransition");c.addClass("notransition");t[0].offsetHeight;c[0].offsetHeight;t.removeClass("notransition");c.removeClass("notransition");t.addClass("icrop-transition");c.addClass("icrop-transition");b?B.setVals(b.x,b.y,b.w,b.h):B.setVals(0,0,c.width(),c.height());clearTimeout(G);G=setTimeout(function(){t.removeClass("icrop-transition");c.removeClass("icrop-transition")},1E3)}function C(){var b=Math.min(y,u.width()),
a;n/p>b/E?a=b/n*p:(a=E,b=a/p*n);q.css({width:b,height:a});c.css({width:b,height:a});q[0].width=n;q[0].height=p;c[0].width=n;c[0].height=p;H(q[0],I,d,e);H(c[0],M,d,e);F()}function H(b,a,m,l){a.clearRect(0,0,b.width,b.height);a.translate(b.width/2,b.height/2);var h=90===l||270===l;a.scale(v&&!h||w&&h?-1:1,w&&!h||v&&h?-1:1);0<l?(a.rotate(l/180*Math.PI),180===l?(a.translate(-b.width/2,-b.height/2),a.drawImage(m,0,0,b.width,b.height),a.translate(b.width/2,b.height/2)):(a.translate(-b.height/2,-b.width/
2),a.drawImage(m,0,0,b.height,b.width),a.translate(b.height/2,b.width/2)),a.rotate(-l/180*Math.PI)):a.drawImage(m,-b.width/2,-b.height/2,b.width,b.height);a.scale(1,1);a.translate(-b.width/2,-b.height/2)}function F(){N.height(q.height()).width(q.width())}function O(b){var a=n,m=p,l=I.getImageData(0,0,a,m).data,h,k=[r(l,a,0,0),r(l,a,a-1,0),r(l,a,a-1,l.length/4/a-1),r(l,a,0,l.length/4/a-1)];h={};for(var g=0;g<k.length;g++){var c=k[g].r+","+k[g].b+","+k[g].g+","+k[g].a;h[c]=h[c]?h[c]+1:1}var k=0,g="",
d;for(d in h)h.hasOwnProperty(d)&&h[d]>k&&(k=h[d],g=d);g=g.split(",");h=g={r:g[0],g:g[1],b:g[2],a:g[3]};k=d=0;g=a;c=m;d=0;a:for(;d<a;d++){for(var e=k;e<m;e++){var f=x(h,r(l,a,d,e));if(1024<f)break a}g--}k=0;a:for(;k<m;k++){for(e=d;e<a;e++)if(f=x(h,r(l,a,e,k)),1024<f)break a;c--}g;a:for(;0<g;g--)for(e=k;e<k+c;e++)if(f=x(h,r(l,a,d+g,e)),1024<f)break a;c;a:for(;0<c;c--)for(e=d;e<d+g;e++)if(f=x(h,r(l,a,e,k+c)),1024<f)break a;return 0===g||0===c?{x:0,y:0,w:a,h:m}:{x:Math.max(0,d-b),y:Math.max(0,k-b),w:Math.max(0,
Math.min(a,g+2*b)),h:Math.max(0,Math.min(m,c+2*b))}}function r(b,a,d,e){a=a*e+d;return{r:b[4*a],g:b[4*a+1],b:b[4*a+2],a:b[4*a+3]}}function x(b,a){return(b.r-a.r)*(b.r-a.r)+(b.g-a.g)*(b.g-a.g)+(b.b-a.b)*(b.b-a.b)+(b.a-a.a)*(b.a-a.a)}z=$(z);var u=$('<div class="icrop-wrap"><canvas class="icrop-preview-canv"></canvas><div class="icrop-bg"></div><div class="icrop-box"><div class="icrop-clip-wrap"><canvas class="icrop-clip-canv"></canvas></div></div></div>'),t=u.find(".icrop-box"),N=u.find(".icrop-bg"),
q=u.find(".icrop-preview-canv"),c=u.find(".icrop-clip-canv");z.html(u);var D,f=this,n,p,e=0,w=!1,v=!1,d=new Image,J="",K=0,L="",B=new Dragger(t,c,function(b,a,d,e){b=parseInt(b);a=parseInt(a);c.css({left:-b,top:-a});D&&D()}),I=q[0].getContext("2d"),M=c[0].getContext("2d");f.getFilename=function(){return J};f.getTemplateId=function(){return K};f.getOriginalUrl=function(){return L};f.setMoveCallback=function(b){D=b};f.setSrc=function(b,a,c,f){e=0;v=w=!1;$(d).off("load").on("load",function(){n=d.naturalWidth;
p=d.naturalHeight;C();A()});d.src=b;J=a;K=~~c;L=f||""};f.getFinalDataUrl=function(b){var a;a=f.getVals();a=0!==a.x||0!==a.y||a.w!==d.naturalWidth||a.h!==d.naturalHeight||0!==e||w||v?!0:!1;if(!a&&"data:"===d.src.substr(0,5))return d.src;a=f.getVals();var c=$("<canvas>").attr({width:a.w,height:a.h});c[0].getContext("2d").drawImage(q[0],a.x,a.y,a.w,a.h,0,0,a.w,a.h);return c[0].toDataURL(b)};f.setVals=function(b){var a=c.width()/(90===e||270===e?d.naturalHeight:d.naturalWidth);A({x:Math.round(b.x*a),
y:Math.round(b.y*a),w:Math.round(b.w*a),h:Math.round(b.h*a)})};f.getVals=function(){var b=(90===e||270===e?d.naturalHeight:d.naturalWidth)/c.width(),a=(90===e||270===e?d.naturalWidth:d.naturalHeight)/c.height(),f=B.getVals();return{x:Math.round(f.x*b),y:Math.round(f.y*a),w:Math.round(f.w*b),h:Math.round(f.h*a)}};f.autoCrop=function(b){f.setVals(O(b))};f.rotateClockwise=function(){e=270===e?0:e+90;var b=n;n=p;p=b;C();A()};f.flipHorizontal=function(){90===e||270===e?w=!w:v=!v;C()};var G}})(window);
